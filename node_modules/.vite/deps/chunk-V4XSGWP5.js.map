{
  "version": 3,
  "sources": ["../../svelte/src/store/shared/index.js"],
  "sourcesContent": ["/** @import { Readable, StartStopNotifier, Subscriber, Unsubscriber, Updater, Writable } from '../public.js' */\r\n/** @import { Stores, StoresValues, SubscribeInvalidateTuple } from '../private.js' */\r\nimport { noop, run_all } from '../../internal/shared/utils.js';\r\nimport { safe_not_equal } from '../../internal/client/reactivity/equality.js';\r\nimport { subscribe_to_store } from '../utils.js';\r\n\r\n/**\r\n * @type {Array<SubscribeInvalidateTuple<any> | any>}\r\n */\r\nconst subscriber_queue = [];\r\n\r\n/**\r\n * Creates a `Readable` store that allows reading by subscription.\r\n *\r\n * @template T\r\n * @param {T} [value] initial value\r\n * @param {StartStopNotifier<T>} [start]\r\n * @returns {Readable<T>}\r\n */\r\nexport function readable(value, start) {\r\n\treturn {\r\n\t\tsubscribe: writable(value, start).subscribe\r\n\t};\r\n}\r\n\r\n/**\r\n * Create a `Writable` store that allows both updating and reading by subscription.\r\n *\r\n * @template T\r\n * @param {T} [value] initial value\r\n * @param {StartStopNotifier<T>} [start]\r\n * @returns {Writable<T>}\r\n */\r\nexport function writable(value, start = noop) {\r\n\t/** @type {Unsubscriber | null} */\r\n\tlet stop = null;\r\n\r\n\t/** @type {Set<SubscribeInvalidateTuple<T>>} */\r\n\tconst subscribers = new Set();\r\n\r\n\t/**\r\n\t * @param {T} new_value\r\n\t * @returns {void}\r\n\t */\r\n\tfunction set(new_value) {\r\n\t\tif (safe_not_equal(value, new_value)) {\r\n\t\t\tvalue = new_value;\r\n\t\t\tif (stop) {\r\n\t\t\t\t// store is ready\r\n\t\t\t\tconst run_queue = !subscriber_queue.length;\r\n\t\t\t\tfor (const subscriber of subscribers) {\r\n\t\t\t\t\tsubscriber[1]();\r\n\t\t\t\t\tsubscriber_queue.push(subscriber, value);\r\n\t\t\t\t}\r\n\t\t\t\tif (run_queue) {\r\n\t\t\t\t\tfor (let i = 0; i < subscriber_queue.length; i += 2) {\r\n\t\t\t\t\t\tsubscriber_queue[i][0](subscriber_queue[i + 1]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tsubscriber_queue.length = 0;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * @param {Updater<T>} fn\r\n\t * @returns {void}\r\n\t */\r\n\tfunction update(fn) {\r\n\t\tset(fn(/** @type {T} */ (value)));\r\n\t}\r\n\r\n\t/**\r\n\t * @param {Subscriber<T>} run\r\n\t * @param {() => void} [invalidate]\r\n\t * @returns {Unsubscriber}\r\n\t */\r\n\tfunction subscribe(run, invalidate = noop) {\r\n\t\t/** @type {SubscribeInvalidateTuple<T>} */\r\n\t\tconst subscriber = [run, invalidate];\r\n\t\tsubscribers.add(subscriber);\r\n\t\tif (subscribers.size === 1) {\r\n\t\t\tstop = start(set, update) || noop;\r\n\t\t}\r\n\t\trun(/** @type {T} */ (value));\r\n\t\treturn () => {\r\n\t\t\tsubscribers.delete(subscriber);\r\n\t\t\tif (subscribers.size === 0 && stop) {\r\n\t\t\t\tstop();\r\n\t\t\t\tstop = null;\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\treturn { set, update, subscribe };\r\n}\r\n\r\n/**\r\n * Derived value store by synchronizing one or more readable stores and\r\n * applying an aggregation function over its input values.\r\n *\r\n * @template {Stores} S\r\n * @template T\r\n * @overload\r\n * @param {S} stores\r\n * @param {(values: StoresValues<S>, set: (value: T) => void, update: (fn: Updater<T>) => void) => Unsubscriber | void} fn\r\n * @param {T} [initial_value]\r\n * @returns {Readable<T>}\r\n */\r\n/**\r\n * Derived value store by synchronizing one or more readable stores and\r\n * applying an aggregation function over its input values.\r\n *\r\n * @template {Stores} S\r\n * @template T\r\n * @overload\r\n * @param {S} stores\r\n * @param {(values: StoresValues<S>) => T} fn\r\n * @param {T} [initial_value]\r\n * @returns {Readable<T>}\r\n */\r\n/**\r\n * @template {Stores} S\r\n * @template T\r\n * @param {S} stores\r\n * @param {Function} fn\r\n * @param {T} [initial_value]\r\n * @returns {Readable<T>}\r\n */\r\nexport function derived(stores, fn, initial_value) {\r\n\tconst single = !Array.isArray(stores);\r\n\t/** @type {Array<Readable<any>>} */\r\n\tconst stores_array = single ? [stores] : stores;\r\n\tif (!stores_array.every(Boolean)) {\r\n\t\tthrow new Error('derived() expects stores as input, got a falsy value');\r\n\t}\r\n\tconst auto = fn.length < 2;\r\n\treturn readable(initial_value, (set, update) => {\r\n\t\tlet started = false;\r\n\t\t/** @type {T[]} */\r\n\t\tconst values = [];\r\n\t\tlet pending = 0;\r\n\t\tlet cleanup = noop;\r\n\t\tconst sync = () => {\r\n\t\t\tif (pending) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tcleanup();\r\n\t\t\tconst result = fn(single ? values[0] : values, set, update);\r\n\t\t\tif (auto) {\r\n\t\t\t\tset(result);\r\n\t\t\t} else {\r\n\t\t\t\tcleanup = typeof result === 'function' ? result : noop;\r\n\t\t\t}\r\n\t\t};\r\n\t\tconst unsubscribers = stores_array.map((store, i) =>\r\n\t\t\tsubscribe_to_store(\r\n\t\t\t\tstore,\r\n\t\t\t\t(value) => {\r\n\t\t\t\t\tvalues[i] = value;\r\n\t\t\t\t\tpending &= ~(1 << i);\r\n\t\t\t\t\tif (started) {\r\n\t\t\t\t\t\tsync();\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\t() => {\r\n\t\t\t\t\tpending |= 1 << i;\r\n\t\t\t\t}\r\n\t\t\t)\r\n\t\t);\r\n\t\tstarted = true;\r\n\t\tsync();\r\n\t\treturn function stop() {\r\n\t\t\trun_all(unsubscribers);\r\n\t\t\tcleanup();\r\n\t\t\t// We need to set this to false because callbacks can still happen despite having unsubscribed:\r\n\t\t\t// Callbacks might already be placed in the queue which doesn't know it should no longer\r\n\t\t\t// invoke this derived store.\r\n\t\t\tstarted = false;\r\n\t\t};\r\n\t});\r\n}\r\n\r\n/**\r\n * Takes a store and returns a new one derived from the old one that is readable.\r\n *\r\n * @template T\r\n * @param {Readable<T>} store  - store to make readonly\r\n * @returns {Readable<T>}\r\n */\r\nexport function readonly(store) {\r\n\treturn {\r\n\t\t// @ts-expect-error TODO i suspect the bind is unnecessary\r\n\t\tsubscribe: store.subscribe.bind(store)\r\n\t};\r\n}\r\n\r\n/**\r\n * Get the current value from a store by subscribing and immediately unsubscribing.\r\n *\r\n * @template T\r\n * @param {Readable<T>} store\r\n * @returns {T}\r\n */\r\nexport function get(store) {\r\n\tlet value;\r\n\tsubscribe_to_store(store, (_) => (value = _))();\r\n\t// @ts-expect-error\r\n\treturn value;\r\n}\r\n"],
  "mappings": "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",
  "names": []
}
