<script lang="ts">import { T, watch } from '@threlte/core';
import { writable } from 'svelte/store';
import { Object3D } from 'three';
import { usePortalContext } from '../usePortalContext';
let { id = 'default', object, children: childrenSnippet } = $props();
const { getPortal } = usePortalContext();
const children = writable([]);
const target = writable();
let portal = $derived(getPortal(id));
$effect.pre(() => target.set(object ?? $portal));
watch([children, target], ([children, target]) => {
    if (target === undefined)
        return;
    for (const child of children) {
        if (target.children.includes(child))
            continue;
        target.add(child);
    }
    return () => {
        for (const child of children) {
            if (target.children.includes(child)) {
                target.remove(child);
            }
        }
    };
});
const proxy = new Object3D();
proxy.add = (child) => {
    children.update((array) => {
        array.push(child);
        return array;
    });
    return child;
};
proxy.remove = (child) => {
    children.update((array) => {
        array.splice(array.indexOf(child), 1);
        return array;
    });
    return child;
};
</script>

{#if $target}
  <T
    is={proxy}
    attach={false}
  >
    {@render childrenSnippet?.()}
  </T>
{/if}
